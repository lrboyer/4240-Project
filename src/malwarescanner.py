import os
import hashlib
from typing import Union
from pathlib import Path
import pandas as pd


class MalwareScanner:

    def __init__(self, database: pd.DataFrame):
        self.database = database

    @staticmethod
    def __list_files_in_directory(directory: Union[Path, str]):
        file_list = []
        for root, directories, files in os.walk(directory):
            for filename in files:
                file_list.append(os.path.join(root, filename))
        return file_list

    @staticmethod
    def __hash_file(fileName: str):
        file_hash = ''
        try:

            if os.path.isfile(fileName):
                with open(fileName, 'rb') as f:
                    file_name_read = f.read()
                    file_hash = hashlib.sha256(file_name_read).hexdigest()

        except Exception as e:
            print(e)

        return file_hash

    def scan_file(self, fileName: str):
        file_hash = self.__hash_file(fileName)
        malware_path = ""

        if file_hash in self.database.index:
            malware_path = os.path.abspath(fileName)

        return malware_path

    def scan_directory(self, directory: Union[Path, str]):
        files = self.__list_files_in_directory(directory)

        malware_list = list()

        for file in files:
            print("Scanning: " + file)
            result = self.scan_file(file)
            if result != "":
                malware_list.append(result)

        return malware_list

import os
import hashlib
from typing import Union
from pathlib import Path
import pandas as pd
import sys


class MalwareScanner:
    """
    Scans your mom
    """

    def __init__(self, database: pd.DataFrame):
        self.database = database

    @staticmethod
    def __list_files_in_directory(directory: Union[Path, str]):
        """
        @return: list of all files in directory
        """
        return [
            os.path.join(root, filename)
            for root, directories, files in os.walk(directory)
            for filename in files
        ]

    @staticmethod
    def __hash_file(fileName: str):
        try:
            if not (os.path.isfile(fileName)):
                return
            with open(fileName, 'rb') as f:
                file_name_read = f.read()
                file_hash = hashlib.sha256(file_name_read).hexdigest()
                return file_hash

        except Exception as e:
            print(e, file=sys.stderr)

    def scan_file(self, file_name: str):
        """
        check if file is found in database
        @param file_name: path of file
        """
        print("Scanning: " + file_name)
        file_hash = self.__hash_file(file_name)
        return file_hash in self.database.index

    def scan_directory(self, directory: Union[Path, str]):
        """
        scans directory for malware
        @param directory: path of directory
        """
        files = self.__list_files_in_directory(directory)
        malicious_files = []

        for file in files:
            if self.scan_file(file):
                malware_path = os.path.abspath(file)
                malicious_files.append(malware_path)

        return malicious_files

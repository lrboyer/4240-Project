import os
from typing import Union
from pathlib import Path
import pandas as pd
from services import util
from services.logger import Logger, VoidLogger
from tqdm import tqdm


class MalwareScanner:
    """
    Scans your mom
    """

    def __init__(self, database: pd.DataFrame, *, logger: Logger = VoidLogger()):
        self.database = database
        self.logger = logger

    def scan_file(self, file_name: str):
        """
        check if file is found in database
        :param file_name: path of file
        """
        self.logger.log("Scanning: " + file_name)
        file_hash = util.hash_file(file_name)
        return file_hash in self.database.index

    def scan_directory(self, directory: Union[Path, str]):
        """
        scans directory for malware
        :param directory: path of directory
        """
        files = util.list_files_in_directory(directory)
        malicious_files = []
        for file in tqdm(files, disable=not isinstance(self.logger, VoidLogger)):
            if self.scan_file(file):
                malware_path = os.path.abspath(file)
                malicious_files.append(malware_path)

        return malicious_files

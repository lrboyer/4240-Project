import os
import hashlib
import argparse
import pandas
from stopwatch import Stopwatch

HOME_PATH = f'{os.getcwd()}'
MALWARE_DB_FILE = HOME_PATH + "/full_sha256.db"

db = pandas.read_csv('full_sha256.db', comment='#')
db.set_index("sha256_hash", inplace=True)


def make_hash(fileName: str):
    file_hash = ''

    try:

        if os.path.isfile(fileName):
            with open(fileName, 'rb') as f:
                file_name_read = f.read()
                file_hash = hashlib.sha256(file_name_read).hexdigest()

    except Exception as e:
        print(e)

    return file_hash


def is_hash_in_db(fileHash: str):
    return fileHash in db.index


def scan_file(fileName: str):
    fileHash = make_hash(fileName)
    malwarePath = ""

    if is_hash_in_db(fileHash):
        malwarePath = os.path.abspath(fileName)

    return malwarePath


def make_file_list(directory: str):
    file_list = []
    for root, directories, files in os.walk(directory):
        for filename in files:
            file_list.append(os.path.join(root, filename))
    return file_list


def scan_directories(inputDir: str):
    files = make_file_list(inputDir)

    malwareList = list()

    for file in files:
        print("Scanning: " + file)
        result = scan_file(file)
        if result != "":
            malwareList.append(result)

    return malwareList


def main():
    parser = argparse.ArgumentParser(description="Malware Scanner 4240")
    parser.add_argument("directory_to_scan", type=str)
    args = parser.parse_args()

    stopwatch = Stopwatch()
    stopwatch.start()
    input_directory: str = args.directory_to_scan

    print("Malware Scanner 4240 Class Project")
    print("Made by Lucas Boyer, Jeremy Sarasua and Ivan Lin")
    print("\n----STARTING MALWARE SCAN----\n")

    if os.path.exists(input_directory):
        results = scan_directories(input_directory)
        print("\n----COMPLETED MALWARE SCAN----\n")

        if results:
            print("FOUND " + str(len(results)) + " MALWARE FILES!")
            for malware in results:
                print(malware)
        else:
            print("No malware found :)")
    else:
        print("Directory " + input_directory + " does not exist!")

    stopwatch.stop()
    print(f"\nTime elapsed: {stopwatch.elapsed_time(): .2f} ")


if __name__ == "__main__":
    main()

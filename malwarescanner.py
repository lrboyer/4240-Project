import os
import sys

from services import (
    Stopwatch,
    DatabaseReader,
    MalwareScanner,
    TypedArgumentParser,
    Logger,
    VoidLogger,
    config
)


def main():
    args = TypedArgumentParser().parse_args()

    stopwatch = Stopwatch()
    logger = Logger() if args.verbose else VoidLogger()

    database = DatabaseReader.read_database(config.MALWARE_DB_FILE)
    malware_scanner = MalwareScanner(database, logger=logger)

    print("Malware Scanner 4240 Class Project")
    print("Made by Lucas Boyer, Jeremy Sarasua and Ivan Lin")
    print("\n----STARTING MALWARE SCAN----\n")

    if not os.path.exists(args.directory_to_scan):
        print("Directory " + args.directory_to_scan + " does not exist!", file=sys.stderr)
        return

    stopwatch.start()
    results = malware_scanner.scan_directory(args.directory_to_scan)
    print("\n----COMPLETED MALWARE SCAN----\n")
    stopwatch.stop()

    if results:
        print("FOUND " + str(len(results)) + " MALWARE FILES!")
        for malware in results:
            print(malware)
    else:
        print("No malware found :)")

    print(f"\nTime elapsed: {stopwatch.elapsed_time(): .2f} ")


if __name__ == "__main__":
    main()

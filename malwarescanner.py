import os
import hashlib
import argparse

HOME_PATH = f'{os.getcwd()}'
MALWARE_DB_FILE = HOME_PATH + "/full_sha256.db"


def make_hash(fileName: str):
    fileHash = ''

    if os.path.isfile(fileName):
        with open(fileName, 'rb') as f:
            fileNameRead = f.read()
            fileHash = hashlib.sha256(fileNameRead).hexdigest()

    return fileHash


def hash_in_db(fileHash: str):
    lineNum = 0

    with open(MALWARE_DB_FILE, "r") as database:
        for line in database:
            lineNum = lineNum + 1

            if len(line.strip()) != 0:
                if not line.startswith('#'):
                    if str(fileHash) in str(line):
                        return True
    return False


def scan_file(fileName: str):
    """
    :filename: 
    """
    scanResult = ""
    fileHash = make_hash(fileName)

    print("Scanning: " + fileName + "|" + fileHash)

    if hash_in_db(fileHash):
        # Print Malware location if found
        malware_path = os.path.abspath(fileName)
        scanResult = malware_path + "|" + fileHash
        print("MALWARE FOUND: " + malware_path + " with hash: " + fileHash)

    return scanResult


def make_file_list(directory: str):
    fileList = []
    for root, directories, files in os.walk(directory):
        for filename in files:
            fileList.append(os.path.join(root, filename))
    return fileList


def scan_directories(inputDir: str):
    files = make_file_list(inputDir)

    for file in files:
        result = scan_file(file)


def main():
    print("Malware  Scanner 4240")
    inputDirectory = input("What directory do you want to scan? ")

    if os.path.exists(inputDirectory):
        scan_directories(inputDirectory)
    else:
        print("Directory " + inputDirectory + " does not exist!")


def main():
    parser = argparse.ArgumentParser(description="Malware Scanner 4240")
    parser.add_argument("directory_to_scan", type=str)
    args = parser.parse_args()

    inputDirectory = args.directory_to_scan

    if os.path.exists(inputDirectory):
        scan_directories(inputDirectory)
    else:
        print("Directory " + inputDirectory + " does not exist!")


if __name__ == "__main__":
    main()

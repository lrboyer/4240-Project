import os
import typed_argparse as tap
from src.stopwatch import Stopwatch
from src.database_reader import DatabaseReader
from src.malwarescanner import MalwareScanner
from src import config
from src.args import Args


def main(args: Args):
    stopwatch = Stopwatch()
    stopwatch.start()
    input_directory: str = args.directory_to_scan

    database = DatabaseReader.read_database(config.MALWARE_DB_FILE)
    malware_scanner = MalwareScanner(database)

    print("Malware Scanner 4240 Class Project")
    print("Made by Lucas Boyer, Jeremy Sarasua and Ivan Lin")
    print("\n----STARTING MALWARE SCAN----\n")

    if os.path.exists(input_directory):
        results = malware_scanner.scan_directory(input_directory)
        print("\n----COMPLETED MALWARE SCAN----\n")

        if results:
            print("FOUND " + str(len(results)) + " MALWARE FILES!")
            for malware in results:
                print(malware)
        else:
            print("No malware found :)")
    else:
        print("Directory " + input_directory + " does not exist!")

    stopwatch.stop()
    print(f"\nTime elapsed: {stopwatch.elapsed_time(): .2f} ")


if __name__ == "__main__":
    tap.Parser(Args).bind(main).run()
